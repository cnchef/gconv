name: Release

on:
  push:
    tags:
      - 'v*.*.*'  # è§¦å‘æ¡ä»¶ï¼šæ¨é€ v1.0.0, v1.2.3 ç­‰æ ¼å¼çš„æ ‡ç­¾

permissions:
  contents: write  # éœ€è¦å†™æƒé™æ¥åˆ›å»º Release

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest
    
    steps:
    - name: Check out code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # è·å–å®Œæ•´å†å²è®°å½•

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: 'stable'

    - name: Run tests
      run: go test -v ./...

    - name: Get version from tag
      id: get_version
      run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

    - name: Generate changelog
      id: changelog
      run: |
        # è·å–ä¸Šä¸€ä¸ªæ ‡ç­¾
        PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
        
        if [ -z "$PREV_TAG" ]; then
          # ç¬¬ä¸€ä¸ªç‰ˆæœ¬ï¼Œæ˜¾ç¤ºæ‰€æœ‰æäº¤
          CHANGELOG=$(git log --pretty=format:"- %s (%h)" --no-merges)
        else
          # æ˜¾ç¤ºä»ä¸Šä¸€ä¸ªæ ‡ç­¾åˆ°å½“å‰æ ‡ç­¾çš„æäº¤
          CHANGELOG=$(git log ${PREV_TAG}..HEAD --pretty=format:"- %s (%h)" --no-merges)
        fi
        
        # ä¿å­˜åˆ°æ–‡ä»¶
        echo "$CHANGELOG" > CHANGELOG.txt
        
        # è¾“å‡ºåˆ° GitHub Actions
        echo "changelog<<EOF" >> $GITHUB_OUTPUT
        echo "$CHANGELOG" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        name: Release ${{ steps.get_version.outputs.VERSION }}
        body: |
          ## ğŸ‰ Release ${{ steps.get_version.outputs.VERSION }}
          
          ### ğŸ“¦ å®‰è£…æ–¹æ³•
          
          ```bash
          go get github.com/cnchef/gconv@${{ steps.get_version.outputs.VERSION }}
          ```
          
          ### ğŸ“ æ›´æ–°å†…å®¹
          
          ${{ steps.changelog.outputs.changelog }}
          
          ### ğŸ“Š é¡¹ç›®çŠ¶æ€
          
          - âœ… æµ‹è¯•è¦†ç›–ç‡ï¼š98.2%
          - âœ… é›¶ç¬¬ä¸‰æ–¹ä¾èµ–
          - âœ… æ”¯æŒ Go 1.20+
          
          ### ğŸ”— ç›¸å…³é“¾æ¥
          
          - [æ–‡æ¡£](https://github.com/cnchef/gconv/blob/${{ steps.get_version.outputs.VERSION }}/README.md)
          - [ç¤ºä¾‹ä»£ç ](https://github.com/cnchef/gconv/tree/${{ steps.get_version.outputs.VERSION }}/examples)
          - [é—®é¢˜åé¦ˆ](https://github.com/cnchef/gconv/issues)
        draft: false
        prerelease: false
        generate_release_notes: true

  # æ³¨æ„ï¼šéªŒè¯æ­¥éª¤å·²ç§»é™¤
  # åŸå› ï¼šåˆšå‘å¸ƒçš„ç‰ˆæœ¬éœ€è¦æ—¶é—´è¢« Go proxy ç´¢å¼•
  # ç”¨æˆ·å¯ä»¥åœ¨å‡ å°æ—¶åæ­£å¸¸å®‰è£…

